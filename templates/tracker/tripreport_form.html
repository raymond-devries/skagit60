{% extends 'base.html' %}
{% load crispy_forms_filters %}
{% load define_action %}
{% load static %}

{% block head %}
    <!--suppress VueDuplicateTag -->
    <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
    <script src="https://unpkg.com/filepond-plugin-image-preview"></script>
    <script src="https://unpkg.com/filepond"></script>
    <script src="https://unpkg.com/vue-filepond"></script>
{% endblock %}

{% block content %}
    <div class="m-4 desktop-width">
        <h2>Trip Report</h2>
        <hr>
        <form method="post">
            {% csrf_token %}
            {{ form|crispy }}
            <hr>
            <div id="app">
                <h5><b>Times</b></h5>
                <div v-for="time in times" class="mb-3 d-flex align-items-center">
                    <h5 class="mr-3">
                        [[ time.start_point_display ]] to [[ time.end_point_display ]]: [[ time.time ]] hours
                    </h5>
                    <button type="button" class="delete-color submit-button small-delete"><b
                            v-on:click="deleteTime(time.id)">
                        Delete</b>
                    </button>
                </div>
                <div class="form-group">
                    <div class="form-row mb-3">
                        <div class="col">
                            <label for="start_point_input">Start Point*</label>
                            <select id="start_point_input" class="form-control" v-model="start_point">
                                <option v-for="choice in time_choices" :value="choice[0]">[[ choice[1] ]]</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="end_point_input">End Point*</label>
                            <select id="end_point_input" class="form-control" v-model="end_point">
                                <option v-for="choice in time_choices" :value="choice[0]">[[ choice[1] ]]</option>
                            </select>
                        </div>
                    </div>
                    <label for="time_input">Time taken in hours*</label>
                    <input type="number" class="form-control" id="time_input" v-model="hours"
                           v-on:keypress.enter.prevent v-on:keypress.enter="addTime">
                </div>
                <button type="button" class="submit-button" v-on:click="addTime">
                    Add Time
                </button>
                <hr>
                <h4>Upload Images</h4>
                <h6>You can upload a maximum of 4 images</h6>
                <div class="custom-file my-3">
                    <label class="custom-file-label" for="picture_upload">Choose images</label>
                    <input type="file" class="custom-file-input" id="picture_input"
                           v-on:change="addImages" multiple accept="image/*">
                </div>
            </div>
            <hr>
            {% if tripreport.published %}
                <input type="submit" class="submit-button my-2" name="save_report" value="Save Report">
            {% else %}
                <input type="submit" class="submit-button my-2" name="save_report" value="Save Draft">
                <input type="submit" class="submit-button my-2" name="publish_report" value="Publish Report">
            {% endif %}
        </form>
        {% if tripreport.peak is not None %}
            <form>
                <button type="submit" formaction="{% url 'trip_report_delete' pk=tripreport.pk %}"
                        class="submit-button delete-color my-3">
                    Delete Report
                </button>
            </form>
        {% endif %}
    </div>
    <script type="text/javascript">

        let app = new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data: {
                trip_report_id: {{ tripreport.id }},
                times: {{ times|safe }},
                time_choices: {{ time_choices|safe }},
                time_api: ('{{ request.scheme }}' + '://' + '{{ request.get_host }}' + '/api/report_time/'),
                start_point: 'TH',
                end_point: 'C',
                image_api: ('{{ request.scheme }}' + '://' + '{{ request.get_host }}' + '/api/report_image/'),
                hours: null,
                images_to_upload: null,
                active_images: 0,
            },
            components: {
                FilePond: vueFilePond.default(FilePondPluginImagePreview)
            },
            mounted() {

            },
            methods: {
                deleteTime: function (time_id) {
                    axios.delete(this.time_api + time_id)
                        .then(this.$delete(this.times, time_id))
                        .catch(function (error) {
                            console.log(error)
                        })
                },
                addTime: function () {
                    axios.post(this.time_api,
                        {
                            'start_point': this.start_point,
                            'end_point': this.end_point,
                            'time': this.hours,
                            'trip_report': this.trip_report_id
                        })
                        .then(
                            response => this.$set(this.times, response.data.id, response.data)
                        ).then(
                        this.hours = null
                    )
                },
                addImages: function (event) {
                    this.images_to_upload = Array.from(event.target.files);
                    this.images_to_upload.forEach(this.uploadImages)
                },
                uploadImages: function (image_to_upload) {
                    image_to_upload = this.resizeImage(image_to_upload);
                    const imageData = new FormData();
                    imageData.append('image', image_to_upload, image_to_upload.name);
                    imageData.append('trip_report', this.trip_report_id);


                    axios.post(this.image_api, imageData)
                        .then(response => console.log(response))
                        .catch(response => console.log(response))
                },
            }
        })
    </script>
{% endblock content %}

